// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ USERS ============

model User {
  id            String   @id @default(cuid())
  walletAddress String   @unique
  nonce         String   // For wallet auth
  totalPoints   Int      @default(0)
  isAdmin       Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  enrollments   UserCourse[]
  lessonProgress UserLesson[]
  quizAttempts  QuizAttempt[]
  transactions  BlockchainTx[] // Keeping for now, though not explicitly in new prompt schema, it's useful
}

// ============ COURSES ============

model Course {
  id                 Int      @id // Matches on-chain course ID
  title              String
  description        String
  longDescription    String   @db.Text
  instructor         String
  category           String
  level              CourseLevel
  thumbnailUrl       String?
  duration           String   // e.g., "2 hours"
  objectives         String[] // Array of learning objectives
  prerequisites      String[] // Array of prerequisites
  completionPoints   Int      // Bonus points for completing (50, 100, or 150)
  minPointsToAccess  Int      @default(0) // Min points to ACCESS (NOT deducted) - for ADVANCED
  enrollmentCost     Int      @default(0) // Points DEDUCTED on enrollment - for PREMIUM
  isPublished        Boolean  @default(false)
  onChainSynced      Boolean  @default(false)
  onChainTxHash      String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  lessons     Lesson[]
  enrollments UserCourse[]
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

// ============ LESSONS ============

model Lesson {
  id              String   @id @default(cuid())
  courseId        Int
  title           String
  description     String?
  orderIndex      Int      // Order within course (0, 1, 2...)
  videoStorageKey String   // S3/R2 key, e.g., "videos/course_1/lesson_1.mp4"
  videoDuration   Int      // Duration in seconds
  watchPoints     Int      @default(10) // Points for watching
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  course         Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  quiz           Quiz?
  userProgress   UserLesson[]

  @@unique([courseId, orderIndex])
}

// ============ QUIZZES ============

model Quiz {
  id           String   @id @default(cuid())
  lessonId     String   @unique
  questions    Json     // Array of { question, options, correctIndex }
  passingScore Int      @default(70) // Percentage needed to pass
  passPoints   Int      @default(20) // Points for passing
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  lesson   Lesson        @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  attempts QuizAttempt[]
}

// ============ USER PROGRESS ============

model UserCourse {
  id                      String    @id @default(cuid())
  userId                  String
  courseId                Int
  enrolledAt              DateTime  @default(now())
  pointsSpent             Int       @default(0) // Points deducted on enrollment
  progressPercent         Int       @default(0)
  isCompleted             Boolean   @default(false)
  completedAt             DateTime?
  completionPointsAwarded Boolean   @default(false)
  onChainSynced           Boolean   @default(false) // For enrollment
  onChainCompletionSynced Boolean   @default(false) // For completion
  enrollTxHash            String?
  completionTxHash        String?

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
}

model UserLesson {
  id                  String    @id @default(cuid())
  userId              String
  lessonId            String
  watchProgressPercent Int      @default(0)
  isWatched           Boolean   @default(false) // True when >= 50%
  watchPointsAwarded  Boolean   @default(false)
  watchedAt           DateTime?
  lastWatchedAt       DateTime?

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
}

model QuizAttempt {
  id              String   @id @default(cuid())
  userId          String
  quizId          String
  answers         Json     // Array of selected indices
  scorePercent    Int
  isPassed        Boolean
  passPointsAwarded Boolean @default(false)
  attemptNumber   Int
  createdAt       DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
}

// Keeping BlockchainTx for transaction tracking as it is useful, adapted to fit new schema references
model BlockchainTx {
  id        String   @id @default(uuid())
  txHash    String   @unique
  type      TxType
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId  Int
  status    TxStatus @default(PENDING)
  error     String?
  gasUsed   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([courseId])
  @@index([status])
}

enum TxStatus {
  PENDING
  SUCCESS
  FAILED
}

enum TxType {
  ENROLL
  PROGRESS_UPDATE
}
